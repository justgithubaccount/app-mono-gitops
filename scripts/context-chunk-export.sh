#!/bin/bash
#
# =======================================
# CREWAI/GPT CONTEXT EXPORT SCRIPT v2.0
# =======================================
#
# Ð­Ñ‚Ð¾Ñ‚ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð½Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°, Ð½Ð¾ Ð¸
# Ñ€Ð°ÑÑÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÑ‚, Ð·Ð°Ñ‡ÐµÐ¼ Ð¾Ð½ ÑÑ‚Ð¾ Ð´ÐµÐ»Ð°ÐµÑ‚, Ñ‡Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ "Ñ‡Ð°Ð½Ðº", Ð¸ ÐºÐ°Ðº
# ÑƒÑÑ‚Ñ€Ð¾ÐµÐ½Ð° Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð° ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° Ð´Ð»Ñ AI/LLM/crewAI.
#
# ÐŸÐ¸ÑˆÐ¸: ./crewai_export.sh [Ð¿Ð°Ð¿ÐºÐ°] [ÑˆÐ°Ð±Ð»Ð¾Ð½_Ñ„Ð°Ð¹Ð»Ð¾Ð²]
# ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: ./crewai_export.sh ./src '*.py'
#
# Ð’ÑÑ‘ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÑ‚ÑÑ Ð² context_output.md
#
# ÐÐ²Ñ‚Ð¾Ñ€: YOU, 2025
# ---------------------------------------

# ÐÐÐ¡Ð¢Ð ÐžÐ™ÐšÐ˜
MAX_CHUNK_SIZE=15000
OUTPUT_FILE="context_output.md"
SCAN_DIR="${1:-.}"
FILE_PATTERN="${2:-*}"

# Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¿Ð°Ð¿Ð¾Ðº, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð½Ðµ Ð½Ð°Ð´Ð¾ Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ‚ÑŒ (Ñ‚Ð¸Ð¿Ð° .git, node_modules)
EXCLUDE_DIRS=("node_modules" ".git" ".venv" "__pycache__" "build" "dist")

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ â€” ÑÑ‚Ñ€Ð¾ÐºÐ° exclude Ð´Ð»Ñ find
gen_exclude_expr() {
  local expr=""
  for d in "${EXCLUDE_DIRS[@]}"; do
    expr+=" -path \"*/$d/*\" -prune -o"
  done
  # ÑƒÐ±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹ -o
  expr="${expr::-2}"
  echo "$expr"
}

# ==== Ð’Ð¡Ð¢ÐÐ’Ð›Ð¯Ð•Ðœ ÐŸÐ ÐžÐ›ÐžÐ“ ====

cat > "$OUTPUT_FILE" <<END
# ðŸ“¦ CREWAI/AI-ÐšÐžÐÐ¢Ð•ÐšÐ¡Ð¢: ÐŸÐ ÐžÐ•ÐšÐ¢ÐÐ«Ð• Ð¤ÐÐ™Ð›Ð«

Ð­Ñ‚Ð¾ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚ Ñ„Ð°Ð¹Ð»Ð¾Ð² Ð¸Ð· Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð° Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð¸ Ð¸ÑÐºÑƒÑÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð¼Ñƒ Ð¸Ð½Ñ‚ÐµÐ»Ð»ÐµÐºÑ‚Ñƒ Ð¸Ð»Ð¸ Ð°Ð³ÐµÐ½Ñ‚Ñƒ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, LLM Ð¸Ð»Ð¸ crewAI).  
Ð—Ð´ÐµÑÑŒ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ñ€Ð°Ð·Ð±Ð¸Ñ‚ Ð½Ð° **Ñ‡Ð°Ð½ÐºÐ¸** â€” Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÐºÑƒÑÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ñ‡Ñ‚Ð¾Ð±Ñ‹ AI Ð¼Ð¾Ð³ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ, Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¸ ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ Ð½Ð° Ð¸Ñ… Ð¾ÑÐ½Ð¾Ð²Ðµ.

---

### ðŸ¤– Ð—Ð°Ñ‡ÐµÐ¼ ÑÑ‚Ð¾ Ð½ÑƒÐ¶Ð½Ð¾?

- Ð‘Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ AI-Ð°Ð³ÐµÐ½Ñ‚Ñƒ Ñ†ÐµÐ»Ð¸ÐºÐ¾Ð¼ â€” ÐµÐ³Ð¾ "ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð½Ð¾Ðµ Ð¾ÐºÐ½Ð¾" Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¾.
- Ð¤Ð°Ð¹Ð»Ñ‹ Ð´ÐµÐ»ÑÑ‚ÑÑ Ð½Ð° Ð»Ð¾Ð³Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ñ‡Ð°ÑÑ‚Ð¸ ("Ñ‡Ð°Ð½ÐºÐ¸").
- Ð£ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ‡Ð°Ð½ÐºÐ° ÐµÑÑ‚ÑŒ Ð¼ÐµÑ‚Ð°Ð´Ð°Ð½Ð½Ñ‹Ðµ: Ñ€Ð¾Ð»ÑŒ, Ð¿ÑƒÑ‚ÑŒ, Ñ‚Ð¸Ð¿, Ð½Ð¾Ð¼ÐµÑ€ Ñ‡Ð°Ð½ÐºÐ°.
- Ð’ Ñ‚Ð°ÐºÐ¾Ð¼ Ð²Ð¸Ð´Ðµ Ð¿Ñ€Ð¾ÐµÐºÑ‚ Ð¼Ð¾Ð¶Ð½Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ, Ñ€ÐµÑ„Ð°ÐºÑ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ, ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ñ†Ð¸ÑŽ Ð¸Ð»Ð¸ Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ð°Ð²Ñ‚Ð¾Ñ‚ÐµÑÑ‚Ñ‹ ÑÐ¸Ð»Ð°Ð¼Ð¸ Ð˜Ð˜.

---

### ðŸ§© Ð§Ñ‚Ð¾ Ñ‚Ð°ÐºÐ¾Ðµ "Ñ‡Ð°Ð½Ðº"?

**Ð§Ð°Ð½Ðº** â€” ÑÑ‚Ð¾ ÐºÑƒÑÐ¾Ðº Ñ„Ð°Ð¹Ð»Ð° Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð°.  
Ð¢Ð°Ðº Ð¿Ñ€Ð¾Ñ‰Ðµ Ð¿ÐµÑ€ÐµÑÑ‹Ð»Ð°Ñ‚ÑŒ Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ.

---

### âš™ï¸ ÐšÐ°Ðº ÑƒÑÑ‚Ñ€Ð¾ÐµÐ½ ÑÑ‚Ð¾Ñ‚ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚?

- ÐŸÑ€Ð¾Ð±ÐµÐ³Ð°ÐµÐ¼ÑÑ Ð¿Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ñƒ, Ð¸ÑÐºÐ»ÑŽÑ‡Ð°Ñ Ñ‚ÐµÑ…Ð¿Ð°Ð¿ÐºÐ¸ (.git, node_modules, ...).
- Ð”Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð° Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÐµÐ³Ð¾ Ñ€Ð¾Ð»ÑŒ Ð¿Ð¾ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð¸ÑŽ.
- Ð•ÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ â€” Ð´ÐµÐ»Ð¸Ð¼ Ð½Ð° Ñ‡Ð°Ð½ÐºÐ¸.
- ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‡Ð°Ð½Ðº Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½ Ð² markdown Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑÐ¼Ð¸.

---

END

# ==== Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯: ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ñ€Ð¾Ð»ÑŒ ====
detect_role() {
  case "$1" in
    *.md) echo "documentation" ;;
    *.txt) echo "text" ;;
    *.py) echo "code-python" ;;
    *.js) echo "code-js" ;;
    *.sh) echo "script-bash" ;;
    *.yaml|*.yml) echo "config-yaml" ;;
    *.json) echo "config-json" ;;
    *.env) echo "env-config" ;;
    *) echo "file" ;;
  esac
}

# ==== Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯: "find" Ñ Ð¸ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸ÐµÐ¼ Ð¿Ð°Ð¿Ð¾Ðº ====
find_cmd="find \"$SCAN_DIR\" "
for d in "${EXCLUDE_DIRS[@]}"; do
  find_cmd+=" -path \"$SCAN_DIR/$d\" -prune -o"
done
find_cmd+=" -type f -name \"$FILE_PATTERN\" -print"

# ==== Ð¦Ð˜ÐšÐ›: ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ñ„Ð°Ð¹Ð»Ð¾Ð² ====
eval $find_cmd | while read -r FILE
do
  ROLE=$(detect_role "$FILE")
  BASENAME=$(basename "$FILE")
  CONTENT=$(cat "$FILE")
  TOTAL_LEN=${#CONTENT}
  if [ $TOTAL_LEN -le $MAX_CHUNK_SIZE ]; then
    CHUNKS=1
  else
    CHUNKS=$(( (TOTAL_LEN + MAX_CHUNK_SIZE - 1) / MAX_CHUNK_SIZE ))
  fi

  for ((i=0; i<CHUNKS; i++))
  do
    START=$(( i * MAX_CHUNK_SIZE ))
    LEN=$(( MAX_CHUNK_SIZE ))
    CHUNK_CONTENT=$(echo -n "$CONTENT" | cut -c $((START+1))-$((START+LEN)))
    {
      echo "-------------------------------------------"
      echo "**role:** $ROLE"
      echo "**file:** $FILE"
      echo "**chunk:** $((i+1))/$CHUNKS"
      echo ""
      echo '```'
      echo "$CHUNK_CONTENT"
      echo '```'
      echo ""
    } >> "$OUTPUT_FILE"
  done
done

echo "âœ… Ð“Ð¾Ñ‚Ð¾Ð²Ð¾! Ð¡Ð¼Ð¾Ñ‚Ñ€Ð¸ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð² $OUTPUT_FILE"
